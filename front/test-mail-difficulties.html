<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Difficult√©s Mail</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #333;
        color: white;
      }
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .difficulty-section {
        margin: 30px 0;
        padding: 20px;
        background: #444;
        border-radius: 10px;
      }
      .difficulty-title {
        font-size: 1.5rem;
        margin-bottom: 15px;
        color: #4caf50;
      }
      .btn {
        padding: 10px 20px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #1976d2;
      }
      .btn.active {
        background: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>üß™ Test des Difficult√©s Mail</h1>

      <div class="difficulty-section">
        <h2 class="difficulty-title">S√©lection de la difficult√©</h2>
        <button class="btn active" onclick="testDifficulty('easy')">
          Facile (3 erreurs)
        </button>
        <button class="btn" onclick="testDifficulty('medium')">
          Moyen (3 erreurs)
        </button>
        <button class="btn" onclick="testDifficulty('hard')">
          Difficile (6 erreurs)
        </button>
      </div>

      <div id="puzzle-container">
        <!-- Le puzzle sera charg√© ici -->
      </div>
    </div>

    <script src="src/puzzles/mail.js"></script>
    <script>
      let currentDifficulty = "easy";

      function testDifficulty(difficulty) {
        currentDifficulty = difficulty;

        // Mettre √† jour les boutons
        document.querySelectorAll(".btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Charger le puzzle avec la difficult√© s√©lectionn√©e
        loadMailPuzzleWithDifficulty(
          document.getElementById("puzzle-container"),
          difficulty
        );
      }

      function loadMailPuzzleWithDifficulty(container, difficulty) {
        // Configuration de la difficult√©
        const mailPuzzles = {
          easy: {
            hint: "Cherche les d√©tails qui ne correspondent pas √† un vrai mail officiel : exp√©diteur, orthographe, liens‚Ä¶ Chaque d√©tail compte pour trouver le chiffre.",
            subject: "V√©rification urgente de votre compte",
            from: "De : service@banquefid√®le.com",
            body: `
                        <p>Bonjour,</p>
                        <p>Nous avons remarqu√© une activit√© inhabitueIle sur votre compte.</p>
                        <p>Merci de cliquer sur ce lien pour v√©rifier vos informations : <a href="http://banquefid√®le.net/account" class="suspicious-link">http://banquefid√®le.net/account</a></p>
                        <p>Cordialement,<br>Service client<br>0969390001</p>
                    `,
            errors: [
              {
                element: ".mail-from",
                text: "service@banquefid√®le.com",
                reason: "Adresse email suspecte (domaine non officiel)",
              },
              {
                element: ".mail-body",
                text: "inhabitueIle",
                reason: "Faute d'orthographe (devrait √™tre 'inhabituelle')",
              },
              {
                element: ".suspicious-link",
                text: "http://banquefid√®le.net/account",
                reason:
                  "Lien non s√©curis√© (http au lieu de https, domaine suspect)",
              },
            ],
            answer: "3",
            maxErrors: 3,
          },
          medium: {
            hint: "M√™me si le mail semble correct √† premi√®re vue, compare-le avec ce que tu sais d'un vrai message officiel : adresse de l'exp√©diteur, lien, formulation, personnalisation du message‚Ä¶ Chaque d√©tail √©trange compte.",
            subject: "Action requise ‚Äì colis en attente",
            from: "De : notifications@colis-express.com",
            body: `
                        <p>Bonjour,</p>
                        <p>Nous avons tent√© de livrer votre colis mais une erreur est survenue.</p>
                        <p>Veuillez cliquer sur ce lien pour r√©soudre le probl√®me et planifier une nouvelle livraison : <a href="https://colis-express.com/delivery" class="suspicious-link">[r√©soudre mon colis]</a></p>
                        <p>Merci pour votre r√©activit√©.</p>
                        <p>Cordialement,<br>Service client Colis Express</p>
                    `,
            errors: [
              {
                element: ".mail-from",
                text: "notifications@colis-express.com",
                reason: "Adresse email suspecte (domaine g√©n√©rique)",
              },
              {
                element: ".suspicious-link",
                text: "[r√©soudre mon colis]",
                reason: "Lien g√©n√©rique sans personnalisation",
              },
              {
                element: ".mail-body",
                text: "Merci pour votre r√©activit√©",
                reason:
                  "Formulation subtilement suspecte (pas de coordonn√©es officielles)",
              },
            ],
            answer: "4",
            maxErrors: 3,
          },
          hard: {
            hint: "Compare ce que tu vois (le nom affich√©, le texte du lien) avec ce que tu peux v√©rifier sans cliquer (l'adresse r√©elle de l'exp√©diteur, l'URL compl√®te en survol ou en copiant le lien, la nature du fichier joint). Cherche les petites diff√©rences ‚Äî homoglyphes, redirections, double extensions, absence de personnalisation, formulation urgente.",
            subject: "URGENT ‚Äî Votre compte sera suspendu dans 24h",
            from: "De : Google Support &lt;support@goog1e-security.com&gt;",
            body: `
                        <p>Bonjour,</p>
                        <p>Nous avons d√©tect√© une activit√© anormale sur votre compte. Pour √©viter la suspension, cliquez ici pour v√©rifier vos informations et t√©l√©charger votre facture de conformit√©.</p>
                        <p><a href="https://accounts.google.com/secure-reset" class="suspicious-link">https://accounts.google.com/secure-reset</a> (lien masqu√©)</p>
                        <p>Pi√®ce jointe : <span class="attachment">facture_1034.pdf.exe</span></p>
                        <p>Cordialement,<br>Google Support</p>
                    `,
            errors: [
              {
                element: ".mail-from",
                text: "support@goog1e-security.com",
                reason: "Homoglyphe dans l'adresse (goog1e au lieu de google)",
              },
              {
                element: ".mail-from",
                text: "Google Support",
                reason: "Nom affich√© ‚â† adresse r√©elle (trompeur)",
              },
              {
                element: ".suspicious-link",
                text: "https://accounts.google.com/secure-reset",
                reason: "Lien masqu√©/URL trompeuse",
              },
              {
                element: ".attachment",
                text: "facture_1034.pdf.exe",
                reason: "Pi√®ce jointe √† double extension (ex√©cutable d√©guis√©)",
              },
              {
                element: ".mail-subject",
                text: "URGENT ‚Äî Votre compte sera suspendu dans 24h",
                reason: "Formulation urgente/mena√ßante",
              },
              {
                element: ".mail-body",
                text: "Bonjour,",
                reason: "Absence de personnalisation (salut g√©n√©rique)",
              },
            ],
            answer: "6",
            maxErrors: 6,
          },
        };

        const puzzle = mailPuzzles[difficulty];

        container.innerHTML = `
                <div class="puzzle-hint" style="display: block;">
                    <strong>üí° Indice :</strong> ${puzzle.hint}
                </div>
                
                <div class="mail-container">
                    <div class="mail-header">
                        <div class="mail-subject">${puzzle.subject}</div>
                        <div class="mail-from">${puzzle.from}</div>
                    </div>
                    
                    <div class="mail-body">
                        ${puzzle.body}
                    </div>
                </div>
                
                <div class="code-input-section">
                    <label for="mail-code">R√©ponse :</label>
                    <input type="text" id="mail-code" maxlength="1" placeholder="?" />
                    <button id="submit-mail" class="btn btn-primary">Valider</button>
                </div>
                
                <div id="mail-feedback" class="feedback"></div>
                
                <div class="error-count">
                    Erreurs trouv√©es : <span id="error-count">0</span>/${puzzle.maxErrors}
                </div>
            `;

        // Configuration des √©v√©nements (simplifi√©e pour le test)
        const codeInput = container.querySelector("#mail-code");
        const submitBtn = container.querySelector("#submit-mail");
        const feedback = container.querySelector("#mail-feedback");
        const errorCount = container.querySelector("#error-count");

        let foundErrors = 0;

        // Configuration des √©l√©ments cliquables
        puzzle.errors.forEach((errorDef, index) => {
          const element = container.querySelector(errorDef.element);
          if (!element) return;

          element.style.cursor = "pointer";
          element.classList.add("highlightable");
          element.title = "Cliquez pour surligner cette erreur";

          element.addEventListener("click", function () {
            if (!this.classList.contains("highlighted")) {
              this.classList.add("highlighted", "correct");
              foundErrors++;
              errorCount.textContent = foundErrors;

              this.style.background = "#4caf50";
              this.style.color = "white";
              this.style.padding = "2px 4px";
              this.style.borderRadius = "3px";

              if (foundErrors === puzzle.maxErrors) {
                feedback.innerHTML = `<div class="success">‚úÖ Toutes les erreurs trouv√©es ! R√©ponse = ${puzzle.answer}</div>`;
                codeInput.value = puzzle.answer;
              } else {
                feedback.innerHTML = `<div class="success">‚úÖ Erreur trouv√©e ! (${foundErrors}/${puzzle.maxErrors})</div>`;
              }
            }
          });
        });

        // Validation manuelle
        submitBtn.addEventListener("click", function () {
          const code = codeInput.value.trim();
          if (code === puzzle.answer) {
            feedback.innerHTML = `<div class="success">‚úÖ Correct ! La r√©ponse est ${puzzle.answer}</div>`;
          } else {
            feedback.innerHTML = `<div class="error">‚ùå Incorrect. Trouvez les ${puzzle.maxErrors} erreurs...</div>`;
          }
        });

        // Protection contre la navigation des liens
        const allLinks = container.querySelectorAll("a");
        allLinks.forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Navigation bloqu√©e :", this.href);
          });
        });
      }

      // Charger le niveau facile par d√©faut
      testDifficulty("easy");
    </script>
  </body>
</html>
